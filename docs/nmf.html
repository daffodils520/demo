<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NMF Decomposition & Visualization</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background: url("https://imgtu.com/uploads/qedut7hc/r-background.webp") center / cover no-repeat;
      font-family: Arial, sans-serif;
    }
    nav {
      display: flex; align-items: center; background-color: #2b78d4;
      padding: 0 20px; height: 40px;
    }
    nav img { height: 30px; margin-right: 10px; }
    nav .brand { font-size: 18px; font-weight: bold; color: white; margin-right: 30px; }
    nav a { color: white; text-decoration: none; margin: 0 12px; font-weight: bold; }
    nav a:hover { text-decoration: underline; }

    .custom-analysis-btn { background-color:#2b78d4; border-color:#2b78d4; color:white; font-weight:bold; }
    .custom-analysis-btn:hover { background-color:#1a5bbf; border-color:#1a5bbf; }
    .btn-primary { background-color:#86DADE; border-color:#86DADE; }
    .btn-primary:hover { background-color:#1a5bbf; border-color:#1a5bbf; }
    .card-header { background-color:#86DADE; color:black; font-weight:bold; }

    .card-body{padding:1.25rem;}
    .sub-card{margin-top:1rem;border:1px solid #dee2e6;border-radius:.5rem;}
    .sub-card-header{background-color:#f8f9fa;padding:.6rem 1rem;border-bottom:1px solid #dee2e6;border-top-left-radius:.5rem;border-top-right-radius:.5rem;}
    .sub-card-body{padding:1rem;}
    .small-muted{font-size:.9rem;color:#6c757d;}
    .spinner-gap{gap:.5rem;align-items:center;}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;}
    .result-img{width:100%;height:auto;border:1px solid #dee2e6;border-radius:.5rem;}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono","Courier New",monospace;background:#f8f9fa;border:1px solid #e9ecef;border-bottom-width:2px;border-radius:.25rem;padding:.1rem .35rem;}
    .result-list li{margin:.25rem 0;}

    /* ✅ Upload widget */
    .input-group > .form-control[readonly] { background-color: #fff; }
    /* 控制下拉菜单整体 */
.dropdown-menu {
  min-width: 220px;       /* 保证有足够宽度，不会被文字撑破 */
  border-radius: 6px;     /* 圆角更美观 */
  overflow: hidden;       /* 避免 hover 颜色超出边框 */
}

/* 控制下拉项 */
.dropdown-menu .dropdown-item {
  font-size: 15px;
  font-weight: bold;
  font-family: "Microsoft YaHei", Arial, sans-serif;
  color: #1a3d7c;
  white-space: nowrap;    /* 避免换行导致错位 */
}

/* hover 样式（背景色不会溢出） */
.dropdown-menu .dropdown-item:hover {
  background-color: #e6f0ff;  /* 自定义 hover 背景色 */
  color: #0d2a57;
}

  </style>
</head>
<body>

  <!-- ✅ 顶部导航栏 -->
  <nav class="navbar navbar-expand-lg" style="background-color:#2b78d4;">
    <img src="https://imgtu.com/uploads/qi8ssrpb/t-file_7142b8.webp" alt="MS2NMF logo">
    <span class="brand">MS2NMF</span>

    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link text-white" href="/">Home</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-white" href="#" id="analysisDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Analysis
          </a>
          <ul class="dropdown-menu" aria-labelledby="analysisDropdown">
            <li><a class="dropdown-item" href="/mass_spectrometry">Data Preprocessing</a></li>
            <li><a class="dropdown-item" href="/matrix_builder">Matrix Construction & Optimization</a></li>
            <li><a class="dropdown-item" href="/nmf">NMF Decomposition & Visualization</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link text-white" href="#">About</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#">Contact</a></li>
      </ul>
    </div>
  </nav>

  <!-- ✅ 页面主体 -->
  <div class="container mt-4">
    <h2 class="mb-4 text-center" style="color:#1a3d7c;">NMF Decomposition & Visualization</h2>

    <!-- Ⅰ. Evaluation -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Evaluation: Select Appropriate components k</h5></div>
      <div class="card-body">
        <form id="evalForm" enctype="multipart/form-data">
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Upload Intensity Matrix (CSV)</h6></div>
            <div class="sub-card-body">
              <div class="input-group">
                <label class="input-group-text btn btn-primary" for="eval_matrix_file">Choose File</label>
                <input type="file" class="d-none file-input" id="eval_matrix_file" name="matrix_file" accept=".csv" required>
                <input class="form-control file-name" value="No file chosen" readonly>
              </div>
            </div>
          </div>
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Evaluation Parameters</h6></div>
            <div class="sub-card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">min_components</label>
                  <input type="number" class="form-control" name="min_components" value="2" min="1" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">max_components</label>
                  <input type="number" class="form-control" name="max_components" value="20" min="2" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">step</label>
                  <input type="number" class="form-control" name="step" value="1" min="1" required>
                </div>
              </div>
            </div>
          </div>
          <button id="evalBtn" type="submit" class="btn custom-analysis-btn mt-4">Run Evaluation</button>
        </form>
        <div id="eval_result" class="mt-3"></div>
      </div>
    </div>

    <!-- Ⅱ. Decomposition -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">NMF Decomposition: Generate matrix W and H</h5></div>
      <div class="card-body">
        <form id="decompForm" enctype="multipart/form-data">
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Upload Intensity Matrix (CSV)</h6></div>
            <div class="sub-card-body">
              <div class="input-group">
                <label class="input-group-text btn btn-primary" for="decomp_matrix_file">Choose File</label>
                <input type="file" class="d-none file-input" id="decomp_matrix_file" name="matrix_file" accept=".csv" required>
                <input class="form-control file-name" value="No file chosen" readonly>
              </div>
              <div class="small-muted mt-1">Same format as evaluation; will decompose by chosen n_components.</div>
            </div>
          </div>
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Parameters</h6></div>
            <div class="sub-card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">k_components</label>
                  <input type="number" class="form-control" name="n_components" value="11" min="1" required>
                </div>
                <input type="hidden" name="min_components" value="2">
                <input type="hidden" name="max_components" value="20">
                <input type="hidden" name="step" value="1">
              </div>
            </div>
          </div>
          <button id="decompBtn" type="submit" class="btn custom-analysis-btn mt-4">Start Analysis</button>
        </form>
        <div id="decomp_result" class="mt-3"></div>
      </div>
    </div>

    <!-- Ⅲ. UMAP Visualization -->
    <div class="card mb-5">
      <div class="card-header"><h5 class="mb-0">UMAP Visualization</h5></div>
      <div class="card-body">
        <div class="sub-card">
          <div class="sub-card-header"><h6 class="mb-0">Upload Files</h6></div>
          <div class="sub-card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Matrix W (CSV, required)</label>
                <div class="input-group">
                  <label class="input-group-text btn btn-primary" for="shared_w_file">Choose File</label>
                  <input type="file" class="d-none file-input" id="shared_w_file" accept=".csv" required>
                  <input class="form-control file-name" value="No file chosen" readonly>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Metadata (CSV, optional)</label>
                <div class="input-group">
                  <label class="input-group-text btn btn-primary" for="shared_meta_file">Choose File</label>
                  <input type="file" class="d-none file-input" id="shared_meta_file" accept=".csv">
                  <input class="form-control file-name" value="No file chosen" readonly>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Spectral Similarity Data (.graphml, optional)</label>
                <div class="input-group">
                  <label class="input-group-text btn btn-primary" for="shared_gnps_file">Choose File</label>
                  <input type="file" class="d-none file-input" id="shared_gnps_file" accept=".graphml">
                  <input class="form-control file-name" value="No file chosen" readonly>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form id="umapCustomForm" class="mt-3">
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Custom UMAP Parameters</h6></div>
            <div class="sub-card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">n_neighbors</label>
                  <input type="number" class="form-control" name="n_neighbors" value="10" min="2" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">min_dist</label>
                  <input type="number" step="0.05" class="form-control" name="min_dist" value="1.0" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">random_state</label>
                  <input type="number" class="form-control" name="random_state" value="42" required>
                </div>
              </div>
            </div>
          </div>
          <button id="umapCustomBtn" type="submit" class="btn custom-analysis-btn mt-2">Start Analysis</button>
        </form>
        <div id="umap_custom_result" class="mt-3"></div>
      </div>
    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    // ✅ Bind upload inputs
    document.querySelectorAll('.file-input').forEach(input => {
      input.addEventListener('change', function () {
        const fileNameInput = this.closest('.input-group').querySelector('.file-name');
        fileNameInput.value = this.files.length ? this.files[0].name : "No file chosen";
      });
    });

    // ✅ Only keep clean filenames (no duplicates)
function normalizeFiles(res){
  const files = {};
  Object.keys(res||{}).forEach(k=>{
    // 只保留 *_filename
    if(k.endsWith('_filename')){
      const base = k.replace(/_filename$/,'');
      files[base] = res[k];
    }
  });
  return files;
}

    function renderGeneric($container, resp){
  if(!resp || resp.error){
    $container.html('<div class="alert alert-danger">'+(resp && resp.error ? resp.error : 'Processing failed')+'</div>');
    return;
  }
  const result = resp.result || {};
  let listHtml='', imgHtml='', otherHtml='';

  Object.keys(result).forEach(key=>{
    const name = result[key];
    if(!name) return;
    if(/\.(png|jpg|jpeg|svg)$/i.test(name)){
      imgHtml += `<div class="mb-3"><div class="small mb-1"><span class="kbd">${key}</span></div>
        <a class="d-block mb-1" href="/download/${encodeURIComponent(name)}" download>Download ${name}</a>
        <img class="result-img" src="/download/${encodeURIComponent(name)}" alt="${name}"/></div>`;
    }else if(/\.csv$/i.test(name)){
      listHtml += `<li><span class="kbd">${key}</span>: <a class="btn btn-link p-0" href="/download/${encodeURIComponent(name)}" download>${name}</a></li>`;
    }else{
      otherHtml += `<div><span class="kbd">${key}</span>: ${name}</div>`;
    }
  });

  if(result.visualization_url){
    otherHtml += `<div class="mt-2">Interactive Visualization: 
      <a class="btn btn-sm btn-success" href="${result.visualization_url}" target="_blank">Open /umap_visualization/</a></div>`;
  }

  $container.html(`<div class="alert alert-success"><h6 class="mb-2">Completed</h6>
    ${listHtml ? `<ul class="mb-3">${listHtml}</ul>` : ''}
    ${imgHtml ? `<div class="preview-grid">${imgHtml}</div>` : ''}
    ${otherHtml}
    ${!listHtml && !imgHtml && !otherHtml ? '<div class="small-muted">(No downloadable results)</div>' : ''}
  </div>`);
}


    function busy($btn, $box, msg){
      if($btn) $btn.prop('disabled', true);
      if($box) $box.html('<div class="alert alert-info d-flex spinner-gap"><div class="spinner-border spinner-border-sm"></div><div>'+ (msg||'Processing...') +'</div></div>');
    }
    function idle($btn){ if($btn) $btn.prop('disabled', false); }

    // Evaluation
    $('#evalForm').on('submit', function(e){
      e.preventDefault();
      const $btn = $('#evalBtn'), $box = $('#eval_result');
      if(!$('#eval_matrix_file').prop('files').length){
        $box.html('<div class="alert alert-warning">Please upload matrix CSV.</div>'); return;
      }
      const fd = new FormData(this);
      busy($btn, $box, 'Evaluating different n_components...');
      $.ajax({
        url:'/process_nmf_evaluate', type:'POST', data:fd,
        processData:false, contentType:false, dataType:'json'
      }).done(resp=>renderGeneric($box, resp))
        .fail(xhr=> $box.html('<div class="alert alert-danger">'+ ((xhr.responseJSON && xhr.responseJSON.error)||'Server error') +'</div>'))
        .always(()=> idle($btn));
    });

    // Decomposition
    $('#decompForm').on('submit', function(e){
      e.preventDefault();
      const $btn = $('#decompBtn'), $box = $('#decomp_result');
      if(!$('#decomp_matrix_file').prop('files').length){
        $box.html('<div class="alert alert-warning">Please upload matrix CSV.</div>'); return;
      }
      const fd = new FormData(this);
      busy($btn, $box, 'Performing NMF decomposition...');
      $.ajax({
        url:'/process_nmf_decomposition', type:'POST', data:fd,
        processData:false, contentType:false, dataType:'json'
      }).done(resp=>renderGeneric($box, resp))
        .fail(xhr=> $box.html('<div class="alert alert-danger">'+ ((xhr.responseJSON && xhr.responseJSON.error)||'Server error') +'</div>'))
        .always(()=> idle($btn));
    });

    // UMAP Visualization
    $('#umapCustomForm').on('submit', function(e){
      e.preventDefault();
      const $btn = $('#umapCustomBtn'), $box = $('#umap_custom_result');
      const w = $('#shared_w_file').prop('files')[0];
      if(!w){ $box.html('<div class="alert alert-warning">Please upload W matrix.</div>'); return; }
      const fd = new FormData(this);
      fd.append('w_matrix_file', w);
      const meta = $('#shared_meta_file').prop('files')[0];
      const gnps = $('#shared_gnps_file').prop('files')[0];
      if(meta) fd.append('metadata_file', meta);
      if(gnps) fd.append('gnps_file', gnps);
      busy($btn, $box, 'Generating UMAP visualization...');
      $.ajax({
        url:'/process_nmf_visualization', type:'POST', data:fd,
        processData:false, contentType:false, dataType:'json'
      }).done(resp=>renderGeneric($box, resp))
        .fail(xhr=> $box.html('<div class="alert alert-danger">'+ ((xhr.responseJSON && xhr.responseJSON.error)||'Server error') +'</div>'))
        .always(()=> idle($btn));
    });
  })();
  </script>
</body>
</html>
